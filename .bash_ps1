#! /usr/bin/env bash
get_number(){
  echo -n $((RANDOM % 231))
}

random_256color(){
  local c=$(get_number)
  # bad constrast colors, get another one
  if [ "$c" -le 17 -o "$c" -ge 232 ]; then
    random_256color
  else
    echo -n "\e[38;05;${c}m"
  fi
}

#get a random color, for use outside ps1, scripts (no i on $-) don't set this var
if [[ "$-" =~ i ]]; then
  export r256=$(random_256color)
fi

# other formatting
_256_1="\[$r256\]"
_256_2="\[$(random_256color)\]"
end="\[\e[0m\]"
underline="\[\e[4m\]"
bold="\[\e[1m\]"
colorMain=$_256_1
colorMeh=$_256_2

makePS1 () {
  # colors
  local purple="\[\e[34m\]"
  local pink="\[\e[35m\]"
  local green="\[\e[32m\]"
  local yellow="\[\e[33m\]"
  local light_black="\[\e[90m\]"
  local black="\[\e[30m\]"
  #The spaces below avoids emoji collapsing on themselves. MacOS Sierra glitch.
  local spacer='  '

  if [ "$(whoami)" != "root" ]; then
    case $(($RANDOM % 7)) in
      0)  decorations="🐺 🌋"$spacer  ;;
      1)  decorations="🌸 🌿"$spacer  ;;
      2)  decorations="🚀 💫"$spacer  ;;
      3)  decorations="🍁 🍷"$spacer  ;;
      4)  decorations="🔮 🦋"$spacer  ;;
      5)  decorations="🌄 🎆"$spacer  ;;
      6)  decorations="🍇 🥓"$spacer  ;;
    esac
  else
    colorMain=$purple
    colorMeh=$black
    colorText=$pink
    decorations="💠 💠"$spacer
  fi

  local horizontalSeparator="$colorMeh$underline$(printf %${COLUMNS}s)$end\n"
  local workdir="$colorMain\w $end"
  local histoty="$colorMeh!\! $end"
  local clock="$colorMeh\@ $end"
  local S="$colorMain\\$ $end$colorText"

  case "$1" in
    "preGit") printf "${horizontalSeparator}${clock}${workdir}";;
    "postGit") printf "\n${decorations}";;
    *) printf "${horizontalSeparator}${clock}${workdir}\n${decorations}";;
  esac

  # printf "${horizontalSeparator}${clock}${workdir}\n${decorations}"
  # printf "${horizontalSeparator}${histoty}${workdir}${clock}\n${decorations}"
}
export PS1=$(makePS1)
export PROMPT_COMMAND="__git_ps1 '$(makePS1 preGit)' '$(makePS1 postGit)' '$colorMeh=> $end$colorMain$underline%s$end'"
